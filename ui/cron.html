<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com;">
  <title>Routines</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Jura:wght@400;500;600;700&family=Sora:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --border: #334155;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent: #22c55e;
      --accent-secondary: #10b981;
      --accent-hover: #16a34a;
      --success: #22c55e;
      --error: #ef4444;
      --warning: #f59e0b;
      --radius: 16px;
      --radius-sm: 10px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Sora', -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', system-ui, sans-serif;
      background:
        radial-gradient(ellipse at top right, rgba(16, 185, 129, 0.08) 0%, transparent 50%),
        radial-gradient(circle, rgba(148, 163, 184, 0.07) 1px, transparent 1px),
        var(--bg-primary);
      background-size: 100% 100%, 24px 24px, 100% 100%;
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    header {
      background: var(--bg-secondary);
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-family: 'Jura', sans-serif;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0;
    }

    header h1 span {
      background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .header-actions button {
      padding: 6px 14px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.15s;
    }

    .header-actions button:hover {
      background: var(--border);
      color: var(--text-primary);
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px 32px 24px;
    }

    .content::-webkit-scrollbar {
      width: 6px;
    }

    .content::-webkit-scrollbar-track {
      background: transparent;
    }

    .content::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .section {
      margin-bottom: 24px;
    }

    .section-title {
      font-family: 'Jura', sans-serif;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
      letter-spacing: -0.02em;
    }

    .section-desc {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    /* Settings Grid - matching settings.html */
    .settings-grid {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }

    .setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      gap: 12px;
    }

    .setting-row:last-child {
      border-bottom: none;
    }

    .setting-row:hover {
      background: var(--bg-tertiary);
    }

    .setting-row label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin: 0;
      white-space: nowrap;
    }

    .setting-row input,
    .setting-row select,
    .setting-row textarea {
      flex: 1;
      max-width: 280px;
      padding: 6px 10px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 12px;
      font-family: inherit;
      outline: none;
    }

    .setting-row input:focus,
    .setting-row select:focus,
    .setting-row textarea:focus {
      border-color: var(--accent);
    }

    .setting-row input::placeholder,
    .setting-row textarea::placeholder {
      color: var(--text-muted);
    }

    .setting-row select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12' fill='%23636366'%3E%3Cpath d='M6 8L2 4h8L6 8z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      padding-right: 24px;
    }

    .setting-row textarea {
      min-height: 60px;
      resize: vertical;
      line-height: 1.4;
    }

    /* Name + Session row */
    .name-session-row {
      display: flex;
      gap: 8px;
      flex: 1;
      max-width: 280px;
    }

    .name-session-row input {
      flex: 1;
      max-width: none;
    }

    .name-session-row select {
      width: 110px;
      flex-shrink: 0;
      max-width: none;
    }

    /* Schedule tabs */
    .schedule-tabs {
      display: flex;
      gap: 4px;
    }

    .schedule-tab {
      padding: 5px 10px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .schedule-tab:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .schedule-tab.active {
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.2) 0%, rgba(236, 72, 153, 0.2) 100%);
      border-color: var(--accent);
      color: var(--text-primary);
    }

    /* Time picker */
    .time-picker {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .time-picker select {
      width: 54px;
      text-align: center;
      padding: 6px 4px;
    }

    .time-picker .separator {
      color: var(--text-muted);
      font-weight: 600;
      font-size: 12px;
    }

    /* Day selector */
    .day-selector {
      display: flex;
      gap: 4px;
    }

    .day-btn {
      width: 36px;
      height: 28px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg-primary);
      color: var(--text-muted);
      font-size: 10px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .day-btn:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .day-btn.selected {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%);
      border-color: transparent;
      color: white;
    }

    /* Interval input */
    .interval-input {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .interval-input select {
      width: 60px;
      text-align: center;
    }

    .interval-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-right: 4px;
    }

    /* Schedule options container */
    .schedule-options {
      display: none;
    }

    .schedule-options.active {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Create button */
    .create-btn {
      padding: 8px 16px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 2px 8px rgba(168, 85, 247, 0.25);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .create-btn:hover {
      background: linear-gradient(135deg, var(--accent-hover) 0%, var(--accent) 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(168, 85, 247, 0.35);
    }

    .create-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Jobs list */
    .jobs-list {
      display: flex;
      flex-direction: column;
    }

    .job-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      transition: all 0.15s ease;
      animation: fadeIn 0.2s ease;
    }

    .job-item:last-child {
      border-bottom: none;
    }

    .job-item:hover {
      background: var(--bg-tertiary);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .job-item.disabled {
      opacity: 0.5;
    }

    .job-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%);
      box-shadow: 0 0 8px var(--accent);
      flex-shrink: 0;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(0.9); }
    }

    .job-item.disabled .job-status {
      background: var(--text-muted);
      box-shadow: none;
      animation: none;
    }

    .job-info {
      flex: 1;
      min-width: 0;
    }

    .job-name {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .job-session-badge {
      font-size: 10px;
      font-weight: 500;
      color: var(--text-muted);
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 2px 6px;
    }

    .job-schedule {
      font-size: 11px;
      color: var(--accent);
      font-weight: 500;
    }

    .job-prompt {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .job-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    .icon-btn {
      width: 28px;
      height: 28px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s;
    }

    .icon-btn:hover {
      background: var(--border);
      color: var(--text-primary);
    }

    .icon-btn.danger:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: var(--error);
      color: var(--error);
    }

    .icon-btn svg {
      width: 12px;
      height: 12px;
    }

    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 32px;
      height: 32px;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 12px;
    }

    /* Toast - Premium glassmorphism design */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      min-width: 200px;
      max-width: 360px;
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 14px 18px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: toastSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 1000;
      overflow: hidden;
      box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.05) inset;
      color: var(--text-primary);
    }

    .toast::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      width: 100%;
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-secondary) 100%);
      animation: toastProgress 3s linear forwards;
      transform-origin: left;
    }

    .toast.success {
      box-shadow:
        0 8px 32px rgba(34, 197, 94, 0.15),
        0 0 0 1px rgba(34, 197, 94, 0.2) inset,
        0 0 20px rgba(34, 197, 94, 0.1);
    }

    .toast.success::before {
      background: linear-gradient(90deg, #22c55e 0%, #4ade80 100%);
    }

    .toast.success .toast-icon {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(74, 222, 128, 0.1) 100%);
      color: #4ade80;
    }

    .toast.error {
      box-shadow:
        0 8px 32px rgba(239, 68, 68, 0.15),
        0 0 0 1px rgba(239, 68, 68, 0.2) inset,
        0 0 20px rgba(239, 68, 68, 0.1);
    }

    .toast.error::before {
      background: linear-gradient(90deg, #ef4444 0%, #f87171 100%);
    }

    .toast.error .toast-icon {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(248, 113, 113, 0.1) 100%);
      color: #f87171;
    }

    .toast-icon {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.2) 0%, rgba(236, 72, 153, 0.1) 100%);
    }

    .toast-icon svg {
      width: 18px;
      height: 18px;
    }

    .toast-content {
      flex: 1;
      min-width: 0;
    }

    .toast-message {
      color: var(--text-primary);
      line-height: 1.4;
      white-space: nowrap;
    }

    .toast.exiting {
      animation: toastSlideOut 0.3s cubic-bezier(0.4, 0, 1, 1) forwards;
    }

    @keyframes toastSlideIn {
      0% {
        transform: translateX(100%) scale(0.8);
        opacity: 0;
      }
      100% {
        transform: translateX(0) scale(1);
        opacity: 1;
      }
    }

    @keyframes toastSlideOut {
      0% {
        transform: translateX(0) scale(1);
        opacity: 1;
      }
      100% {
        transform: translateX(100%) scale(0.8);
        opacity: 0;
      }
    }

    @keyframes toastProgress {
      from { transform: scaleX(1); }
      to { transform: scaleX(0); }
    }

    /* Full width row for prompt */
    .setting-row.full-width {
      flex-direction: column;
      align-items: stretch;
      gap: 6px;
    }

    .setting-row.full-width textarea {
      max-width: none;
    }

    /* Schedule row with nested elements */
    .setting-row.schedule-row {
      flex-wrap: wrap;
      gap: 8px;
    }

    .setting-row.schedule-row > label {
      width: 100%;
      margin-bottom: -4px;
    }
  </style>
</head>
<body>
  <header>
    <h1><span>Routines</span></h1>
    <div class="header-actions">
      <button onclick="playNormalClick(); window.close()">Done</button>
    </div>
  </header>

  <main class="content">
    <section class="section">
      <div class="settings-grid">
        <div class="setting-row">
          <label>Job Name</label>
          <div class="name-session-row">
            <input type="text" id="job-name" placeholder="morning-vibes" />
            <select id="job-session">
              <option value="default">Default</option>
            </select>
          </div>
        </div>

        <div class="setting-row schedule-row">
          <label>When</label>
          <div class="schedule-tabs">
            <div class="schedule-tab active" data-type="daily">Daily</div>
            <div class="schedule-tab" data-type="weekdays">Weekdays</div>
            <div class="schedule-tab" data-type="interval">Every...</div>
            <div class="schedule-tab" data-type="custom">Specific Days</div>
          </div>

          <div class="schedule-options active" id="options-daily">
            <div class="time-picker">
              <select id="hour-daily"></select>
              <span class="separator">:</span>
              <select id="minute-daily"></select>
              <select id="ampm-daily">
                <option value="AM">AM</option>
                <option value="PM">PM</option>
              </select>
            </div>
          </div>

          <div class="schedule-options" id="options-weekdays">
            <div class="time-picker">
              <select id="hour-weekdays"></select>
              <span class="separator">:</span>
              <select id="minute-weekdays"></select>
              <select id="ampm-weekdays">
                <option value="AM">AM</option>
                <option value="PM">PM</option>
              </select>
            </div>
          </div>

          <div class="schedule-options" id="options-interval">
            <div class="interval-input">
              <select id="interval-hours">
                <option value="0" selected>0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="6">6</option>
                <option value="8">8</option>
                <option value="12">12</option>
                <option value="24">24</option>
              </select>
              <span class="interval-label">hrs</span>
              <select id="interval-minutes">
                <option value="0">0</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="15">15</option>
                <option value="20">20</option>
                <option value="30" selected>30</option>
                <option value="45">45</option>
              </select>
              <span class="interval-label">mins</span>
            </div>
          </div>

          <div class="schedule-options" id="options-custom">
            <div class="day-selector">
              <button type="button" class="day-btn" data-day="0">Sun</button>
              <button type="button" class="day-btn" data-day="1">Mon</button>
              <button type="button" class="day-btn" data-day="2">Tue</button>
              <button type="button" class="day-btn" data-day="3">Wed</button>
              <button type="button" class="day-btn" data-day="4">Thu</button>
              <button type="button" class="day-btn" data-day="5">Fri</button>
              <button type="button" class="day-btn" data-day="6">Sat</button>
            </div>
            <div class="time-picker">
              <select id="hour-custom"></select>
              <span class="separator">:</span>
              <select id="minute-custom"></select>
              <select id="ampm-custom">
                <option value="AM">AM</option>
                <option value="PM">PM</option>
              </select>
            </div>
          </div>
        </div>

        <div class="setting-row full-width">
          <label>Prompt</label>
          <textarea id="job-prompt" placeholder="what should i do when this kicks off? âœ¨"></textarea>
        </div>

        <div class="setting-row">
          <label></label>
          <button class="create-btn" onclick="playNormalClick(); createJob()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Let's Go!
          </button>
        </div>
      </div>
    </section>

    <section class="section">
      <h2 class="section-title">Running on Autopilot</h2>
      <p class="section-desc">Your scheduled routines.</p>

      <div class="settings-grid">
        <div id="jobs-list" class="jobs-list">
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            <p>Loading...</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Click Sound -->
  <audio id="normal-click-sound" preload="auto" src="../assets/normal-click.mp3"></audio>

  <script>
    // Click sound
    const normalClickSound = document.getElementById('normal-click-sound');
    function playNormalClick() {
      if (normalClickSound) {
        normalClickSound.currentTime = 0;
        normalClickSound.play().catch(() => {});
      }
    }
    document.addEventListener('click', (e) => {
      if (e.target.closest('button, .toggle, .tab, .day-btn, select, .routine-item')) {
        playNormalClick();
      }
    });

    // Generate hour options (1-12)
    function generateHourOptions() {
      let html = '';
      for (let i = 1; i <= 12; i++) {
        const selected = i === 9 ? 'selected' : '';
        html += `<option value="${i}" ${selected}>${i}</option>`;
      }
      return html;
    }

    // Generate minute options (00, 15, 30, 45)
    function generateMinuteOptions() {
      return `
        <option value="0">00</option>
        <option value="15">15</option>
        <option value="30">30</option>
        <option value="45">45</option>
      `;
    }

    // Insert generated options
    document.querySelectorAll('select[id^="hour-"]').forEach(el => {
      el.innerHTML = generateHourOptions();
    });
    document.querySelectorAll('select[id^="minute-"]').forEach(el => {
      el.innerHTML = generateMinuteOptions();
    });

    // Schedule type tabs
    let currentScheduleType = 'daily';
    const selectedDays = new Set();

    document.querySelectorAll('.schedule-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.schedule-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.schedule-options').forEach(o => o.classList.remove('active'));

        tab.classList.add('active');
        currentScheduleType = tab.dataset.type;
        document.getElementById(`options-${currentScheduleType}`).classList.add('active');
      });
    });

    // Day selector buttons
    document.querySelectorAll('.day-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const day = btn.dataset.day;
        if (selectedDays.has(day)) {
          selectedDays.delete(day);
          btn.classList.remove('selected');
        } else {
          selectedDays.add(day);
          btn.classList.add('selected');
        }
      });
    });

    // Convert 12h to 24h
    function to24Hour(hour, minute, ampm) {
      let h = parseInt(hour);
      if (ampm === 'PM' && h !== 12) h += 12;
      if (ampm === 'AM' && h === 12) h = 0;
      return { hour: h, minute: parseInt(minute) };
    }

    // Build cron expression from UI
    function buildCronExpression() {
      if (currentScheduleType === 'interval') {
        const hours = parseInt(document.getElementById('interval-hours').value);
        const minutes = parseInt(document.getElementById('interval-minutes').value);

        // Convert to total minutes for the cron expression
        const totalMinutes = (hours * 60) + minutes;

        if (totalMinutes === 0) {
          // Default to 30 minutes if nothing selected
          return `*/30 * * * *`;
        } else if (hours > 0 && minutes === 0) {
          // Pure hours interval
          return `0 */${hours} * * *`;
        } else if (hours === 0) {
          // Pure minutes interval
          return `*/${minutes} * * * *`;
        } else {
          // Mixed hours and minutes - use total minutes
          return `*/${totalMinutes} * * * *`;
        }
      }

      const suffix = currentScheduleType === 'weekdays' ? 'weekdays' :
                     currentScheduleType === 'custom' ? 'custom' : 'daily';

      const hour = document.getElementById(`hour-${suffix}`).value;
      const minute = document.getElementById(`minute-${suffix}`).value;
      const ampm = document.getElementById(`ampm-${suffix}`).value;
      const time = to24Hour(hour, minute, ampm);

      if (currentScheduleType === 'daily') {
        return `${time.minute} ${time.hour} * * *`;
      } else if (currentScheduleType === 'weekdays') {
        return `${time.minute} ${time.hour} * * 1-5`;
      } else if (currentScheduleType === 'custom') {
        if (selectedDays.size === 0) {
          return `${time.minute} ${time.hour} * * *`;
        }
        const days = Array.from(selectedDays).sort().join(',');
        return `${time.minute} ${time.hour} * * ${days}`;
      }
    }

    // Parse timestamp from database (SQLite stores UTC without 'Z' suffix)
    function parseDbTimestamp(timestamp) {
      if (!timestamp) return new Date();
      // Check if timestamp has an explicit timezone indicator
      const hasTimezone = /Z$|[+-]\d{2}:?\d{2}$/.test(timestamp);
      if (hasTimezone) {
        return new Date(timestamp);
      }
      // No timezone - all DB timestamps are UTC, so add 'Z'
      const normalized = timestamp.replace(' ', 'T');
      return new Date(normalized + 'Z');
    }

    // Convert job schedule to human-readable
    function scheduleToHuman(job) {
      const scheduleType = job.schedule_type || 'cron';

      // Handle 'at' type (one-time scheduled)
      if (scheduleType === 'at' && job.run_at) {
        const runAt = parseDbTimestamp(job.run_at);
        const now = new Date();
        const isToday = runAt.toDateString() === now.toDateString();
        const tomorrow = new Date(now);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const isTomorrow = runAt.toDateString() === tomorrow.toDateString();

        const h = runAt.getHours();
        const m = runAt.getMinutes();
        const ampm = h >= 12 ? 'PM' : 'AM';
        const displayHour = h === 0 ? 12 : h > 12 ? h - 12 : h;
        const displayMinute = m.toString().padStart(2, '0');
        const timeStr = `${displayHour}:${displayMinute} ${ampm}`;

        if (isToday) return `Today at ${timeStr}`;
        if (isTomorrow) return `Tomorrow at ${timeStr}`;
        return `${runAt.toLocaleDateString()} at ${timeStr}`;
      }

      // Handle 'every' type (interval-based)
      if (scheduleType === 'every' && job.interval_ms) {
        const ms = job.interval_ms;
        if (ms < 60000) return `Every ${Math.round(ms / 1000)} seconds`;
        if (ms < 3600000) return `Every ${Math.round(ms / 60000)} minutes`;
        if (ms < 86400000) {
          const hrs = Math.round(ms / 3600000);
          return `Every ${hrs} hour${hrs === 1 ? '' : 's'}`;
        }
        const days = Math.round(ms / 86400000);
        return `Every ${days} day${days === 1 ? '' : 's'}`;
      }

      // Handle 'cron' type
      const cron = job.schedule;
      if (!cron) return 'Unknown schedule';

      const parts = cron.split(' ');
      if (parts.length !== 5) return cron;

      const [minute, hour, dom, month, dow] = parts;

      // Interval patterns in cron
      if (minute.startsWith('*/')) {
        const mins = minute.slice(2);
        return `Every ${mins} minutes`;
      }
      if (hour.startsWith('*/')) {
        const hrs = hour.slice(2);
        return `Every ${hrs} hour${hrs === '1' ? '' : 's'}`;
      }

      // Time-based patterns
      const h = parseInt(hour);
      const m = parseInt(minute);
      const ampm = h >= 12 ? 'PM' : 'AM';
      const displayHour = h === 0 ? 12 : h > 12 ? h - 12 : h;
      const displayMinute = m.toString().padStart(2, '0');
      const timeStr = `${displayHour}:${displayMinute} ${ampm}`;

      // Day patterns
      if (dow === '*' && dom === '*') {
        return `${timeStr} daily`;
      }
      if (dow === '1-5') {
        return `${timeStr} weekdays`;
      }
      if (dow === '0,6') {
        return `${timeStr} weekends`;
      }
      if (dow !== '*') {
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const days = dow.split(',').map(d => dayNames[parseInt(d)]).join(', ');
        return `${timeStr} on ${days}`;
      }

      return `${timeStr} daily`;
    }

    const jobsList = document.getElementById('jobs-list');
    let sessionsMap = {}; // Map session_id to session name

    window.addEventListener('DOMContentLoaded', async () => {
      await loadSessions();
      await loadJobs();
    });

    async function loadSessions() {
      try {
        const sessions = await window.pocketAgent.getSessions();
        const sessionSelect = document.getElementById('job-session');
        sessionsMap = {};

        sessionSelect.innerHTML = sessions.map(s => {
          sessionsMap[s.id] = s.name;
          const isDefault = s.id === 'default';
          return `<option value="${escapeAttr(s.id)}"${isDefault ? ' selected' : ''}>${escapeHtml(s.name)}</option>`;
        }).join('');
      } catch (err) {
        console.error('Failed to load sessions:', err);
      }
    }

    async function loadJobs() {
      try {
        const allJobs = await window.pocketAgent.getCronJobs();
        // Filter to only show recurring jobs (cron and every types), not one-time 'at' jobs
        const jobs = allJobs.filter(job => {
          const scheduleType = job.schedule_type || 'cron';
          return scheduleType !== 'at';
        });

        if (jobs.length === 0) {
          jobsList.innerHTML = `
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
              </svg>
              <p>nothing scheduled yet!</p>
            </div>
          `;
          return;
        }

        jobsList.innerHTML = jobs.map((job, i) => {
          const sessionName = sessionsMap[job.session_id] || job.session_id || 'Default';
          return `
          <div class="job-item ${job.enabled ? '' : 'disabled'}" style="animation-delay: ${i * 50}ms">
            <div class="job-status"></div>
            <div class="job-info">
              <div class="job-name">${escapeHtml(job.name)}<span class="job-session-badge">${escapeHtml(sessionName)}</span></div>
              <div class="job-schedule">${scheduleToHuman(job)}</div>
              <div class="job-prompt">${escapeHtml(job.prompt)}</div>
            </div>
            <div class="job-actions">
              <button class="icon-btn" onclick="playNormalClick(); toggleJob('${escapeAttr(job.name)}', ${!job.enabled})" title="${job.enabled ? 'Pause' : 'Resume'}">
                ${job.enabled
                  ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>'
                  : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>'
                }
              </button>
              <button class="icon-btn" onclick="playNormalClick(); runJob('${escapeAttr(job.name)}')" title="Test run">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M9 3h6v5l3 9H6l3-9V3z"/><path d="M9 3h6"/><path d="M10 12h4"/>
                </svg>
              </button>
              <button class="icon-btn danger" onclick="playNormalClick(); deleteJob('${escapeAttr(job.name)}')" title="Delete">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
              </button>
            </div>
          </div>
        `}).join('');
      } catch (err) {
        jobsList.innerHTML = `<div class="empty-state"><p>Error: ${escapeHtml(err.message)}</p></div>`;
      }
    }

    async function createJob() {
      const name = document.getElementById('job-name').value.trim();
      const prompt = document.getElementById('job-prompt').value.trim();
      const sessionId = document.getElementById('job-session').value;

      if (!name || !prompt) {
        showToast('Need a name and prompt!', 'error');
        return;
      }

      const schedule = buildCronExpression();

      try {
        const result = await window.pocketAgent.createCronJob(name, schedule, prompt, 'default', sessionId);
        if (result.success) {
          document.getElementById('job-name').value = '';
          document.getElementById('job-prompt').value = '';
          showToast('Routine created! ðŸŽ‰', 'success');
          loadJobs();
        } else {
          showToast('Couldn\'t create that', 'error');
        }
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function toggleJob(name, enabled) {
      try {
        await window.pocketAgent.toggleCronJob(name, enabled);
        showToast(enabled ? 'Back at it!' : 'Taking a break', 'success');
        loadJobs();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function runJob(name) {
      showToast('On it!', 'success');
      try {
        await window.pocketAgent.runCronJob(name);
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    async function deleteJob(name) {
      if (!confirm(`Delete "${name}"?`)) return;

      try {
        await window.pocketAgent.deleteCronJob(name);
        showToast('Poof! Gone.', 'success');
        loadJobs();
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    function showToast(message, type = 'success') {
      const existing = document.querySelector('.toast');
      if (existing) {
        existing.classList.add('exiting');
        setTimeout(() => existing.remove(), 300);
      }

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <div class="toast-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            ${type === 'success'
              ? '<path d="M20 6L9 17l-5-5"/>'
              : '<circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/>'}
          </svg>
        </div>
        <div class="toast-content">
          <div class="toast-message">${escapeHtml(message)}</div>
        </div>
      `;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.classList.add('exiting');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function escapeAttr(text) {
      return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }
  </script>
</body>
</html>
